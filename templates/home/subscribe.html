{% extends "layouts/base-fullscreen.html" %}

{% block title %} Subscribe {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} login-page {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
{% endblock stylesheets %}

{% block content %}
<button id="test">TEST</button>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const PUBLIC_VAPID_KEY = "BGvSnZTJRPGnqgPBarWLcPzWMcyooU_kuwMCxMES3htyhtUKX8-JRCzcvvGIf7uSdATZ_L16snufH2-feTGPidY";  

    // Convert VAPID key to Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
    }

    // Register Service Worker
    async function registerServiceWorker() {
        try {
            const registration = await navigator.serviceWorker.register("/sw.js");
            console.log("Service Worker registered:", registration);
            return registration;
        } catch (error) {
            console.error("Service Worker registration failed:", error);
        }
    }

    // Subscribe User
    async function subscribeUser(registration) {
        try {
            const applicationServerKey = urlBase64ToUint8Array(PUBLIC_VAPID_KEY);
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            });

            console.log("User subscribed:", subscription);
            localStorage.setItem("sub_token", JSON.stringify(subscription));

            await $.ajax({
                type: "POST",
                url: "/subscribe",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ sub_token: localStorage.getItem("sub_token") }),
            });

        } catch (err) {
            if (Notification.permission === "denied") {
                console.warn("Permission for notifications was denied");
            } else {
                console.error("Failed to subscribe user:", err);
            }
        }
    }

    // On page load
    if ("serviceWorker" in navigator && "PushManager" in window) {
        window.addEventListener("load", async () => {
            try {
                // Request notification permission first
                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    console.warn("Notifications not granted by user");
                    return;
                }

                // Register service worker
                const registration = await registerServiceWorker();

                // Wait until itâ€™s ready
                const readyReg = await navigator.serviceWorker.ready;
                console.log("Service Worker ready:", readyReg);

                // Subscribe user
                await subscribeUser(readyReg);
            } catch (error) {
                console.error("Setup error:", error);
            }
        });
    } else {
        console.warn("Push messaging is not supported in this browser.");
    }

    // Test button
    document.getElementById("test").addEventListener("click", async () => {
        await fetch("/send_notification", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Hello User!" })
        });
    });
  </script>
{% endblock javascripts %}
