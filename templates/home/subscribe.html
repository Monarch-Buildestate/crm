{% extends "layouts/base-fullscreen.html" %}

{% block title %} Subscribe {% endblock %} 

{% block body_class %} login-page {% endblock body_class %}

{% block stylesheets %}
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
{% endblock stylesheets %}

{% block content %}
<button id="subscribeBtn">Enable Notifications</button>
<button id="test">TEST</button>
{% endblock content %}

{% block javascripts %}
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const PUBLIC_VAPID_KEY = "BGvSnZTJRPGnqgPBarWLcPzWMcyooU_kuwMCxMES3htyhtUKX8-JRCzcvvGIf7uSdATZ_L16snufH2-feTGPidY";  

    function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
    }

    async function registerServiceWorker() {
        try {
            const registration = await navigator.serviceWorker.register("/sw.js");
            console.log("Service Worker registered:", registration);
            return registration;
        } catch (error) {
            console.error("Service Worker registration failed:", error);
            throw error;
        }
    }

    async function subscribeUser(registration) {
        try {
            const applicationServerKey = urlBase64ToUint8Array(PUBLIC_VAPID_KEY);
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            });

            console.log("User subscribed:", subscription);
            localStorage.setItem("sub_token", JSON.stringify(subscription));

            await $.ajax({
                type: "POST",
                url: "/subscribe",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ sub_token: localStorage.getItem("sub_token") }),
            });

        } catch (err) {
            if (Notification.permission === "denied") {
                console.warn("Permission for notifications was denied");
            } else {
                console.error("Failed to subscribe user:", err);
            }
        }
    }

    // Check support before anything else
    if (!("serviceWorker" in navigator && "PushManager" in window)) {
        alert("Your browser does not support notifications.");
        window.location.href = "/";
    }

    // User-triggered subscription flow
    document.getElementById("subscribeBtn").addEventListener("click", async () => {
        try {
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("You must allow notifications to subscribe.");
                return;
            }

            const registration = await registerServiceWorker();
            const readyReg = await navigator.serviceWorker.ready;
            console.log("Service Worker ready:", readyReg);

            await subscribeUser(readyReg);
            alert("Subscribed successfully!");
        } catch (error) {
            console.error("Setup error:", error);
        }
    });

    // Test button
    document.getElementById("test").addEventListener("click", async () => {
        await fetch("/send_notification", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Hello User!" })
        });
    });
  </script>
{% endblock javascripts %}
