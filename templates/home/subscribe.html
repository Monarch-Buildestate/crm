{% extends "layouts/base-fullscreen.html" %}

{% block title %} Subscribe {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} login-page {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="/static/assets/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">

{% endblock stylesheets %}

{% block content %}

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const PUBLIC_VAPID_KEY = "BPTBcT6_yjiI5Fb8L-WTd-x7NmAhSxqXV8jBPh0PU7qPak3rib6Ym2IqWhYYRM4w-vBgSxDRTAXaU-WdNr6yMqg";  // Use the public key from Flask

    async function registerServiceWorker() {
        if ("serviceWorker" in navigator) {
            try {
                const registration = await navigator.serviceWorker.register("/sw.js");
                console.log("Service Worker Registered:", registration);
                return registration;
            } catch (error) {
                console.error("Service Worker Registration Failed:", error);
            }
        }
    }

    async function subscribeUser() {
        const registration = await registerServiceWorker();
        if (!registration || !("PushManager" in window)) {
            console.error("Push Messaging is not supported");
            return;
        }

        try {
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY),
            });
            console.log("whatever")

            console.log("Push Subscription:", JSON.stringify(subscription));

            // Send subscription to your Flask backend
            await fetch("/subscribe", {
                method: "POST",
                body: JSON.stringify(subscription),
                headers: { "Content-Type": "application/json" },
            });

            console.log("Subscription sent to server");
        } catch (error) {
            console.error("Subscription Failed:", error);
        }
    }

    // Convert VAPID key to Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
    }

    // Call the subscribe function when the page loads and then redirect to the home page
    window.addEventListener("load", async () => {
        await subscribeUser();
        window.location.href = "/";
    });

  </script>

{% endblock javascripts %}